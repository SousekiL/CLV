<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Customer Lifetime Prediction Using Probabilistic Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="CLV - Final_files/libs/clipboard/clipboard.min.js"></script>
<script src="CLV - Final_files/libs/quarto-html/quarto.js"></script>
<script src="CLV - Final_files/libs/quarto-html/popper.min.js"></script>
<script src="CLV - Final_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="CLV - Final_files/libs/quarto-html/anchor.min.js"></script>
<link href="CLV - Final_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="CLV - Final_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="CLV - Final_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="CLV - Final_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="CLV - Final_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Customer Lifetime Prediction Using Probabilistic Models</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="final-report" class="level3">
<h3 class="anchored" data-anchor-id="final-report">Final Report</h3>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>config InlineBackend.figure_format <span class="op">=</span> <span class="st">'svg'</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xlrd</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>mpl.rcParams.update(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"font.family"</span>: <span class="st">"sans-serif"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"font.sans-serif"</span>: [<span class="st">"Arial"</span>],  <span class="co"># Mac/Windows 常用</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"font.size"</span>: <span class="dv">10</span>,  <span class="co"># 全局基础字号</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.titlesize"</span>: <span class="dv">11</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"axes.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xtick.labelsize"</span>: <span class="dv">9</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ytick.labelsize"</span>: <span class="dv">9</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"legend.fontsize"</span>: <span class="dv">9</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"figure.titlesize"</span>: <span class="dv">12</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"ggplot"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_excel(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"/Users/sousekilyu/Documents/Python/CLV/online_retail_II.xlsx"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    sheet_name<span class="op">=</span>[<span class="st">"Year 2009-2010"</span>, <span class="st">"Year 2010-2011"</span>],</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df1 <span class="op">=</span> df[<span class="st">"Year 2009-2010"</span>]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> df[<span class="st">"Year 2010-2011"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df1.shape, df2.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>((525461, 8), (541910, 8))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sum</span>([df1.shape[<span class="dv">0</span>], df2.shape[<span class="dv">0</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>1067371</code></pre>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.concat([df1, df2], axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>data.head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Invoice</th>
<th data-quarto-table-cell-role="th">StockCode</th>
<th data-quarto-table-cell-role="th">Description</th>
<th data-quarto-table-cell-role="th">Quantity</th>
<th data-quarto-table-cell-role="th">InvoiceDate</th>
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">Country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>489434</td>
<td>85048</td>
<td>15CM CHRISTMAS GLASS BALL 20 LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.95</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>489434</td>
<td>79323P</td>
<td>PINK CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>489434</td>
<td>79323W</td>
<td>WHITE CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>489434</td>
<td>22041</td>
<td>RECORD FRAME 7" SINGLE SIZE</td>
<td>48</td>
<td>2009-12-01 07:45:00</td>
<td>2.10</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>489434</td>
<td>21232</td>
<td>STRAWBERRY CERAMIC TRINKET BOX</td>
<td>24</td>
<td>2009-12-01 07:45:00</td>
<td>1.25</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>data.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(1067371, 8)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data.isnull().<span class="bu">sum</span>()<span class="op">/</span>data.shape[<span class="dv">0</span>]<span class="op">*</span><span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Invoice         0.000000
StockCode       0.000000
Description     0.410541
Quantity        0.000000
InvoiceDate     0.000000
Price           0.000000
Customer ID    22.766873
Country         0.000000
dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first drop the rows where the description is null</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>data.dropna(axis <span class="op">=</span> <span class="dv">0</span>, subset <span class="op">=</span> [<span class="st">"Description"</span>], inplace <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>data.isnull().<span class="bu">sum</span>() <span class="co">#Now let's check the data before droping these customer ID's</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Invoice             0
StockCode           0
Description         0
Quantity            0
InvoiceDate         0
Price               0
Customer ID    238625
Country             0
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>data[data[<span class="st">"Customer ID"</span>].isnull()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Invoice</th>
<th data-quarto-table-cell-role="th">StockCode</th>
<th data-quarto-table-cell-role="th">Description</th>
<th data-quarto-table-cell-role="th">Quantity</th>
<th data-quarto-table-cell-role="th">InvoiceDate</th>
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">Country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">263</td>
<td>489464</td>
<td>21733</td>
<td>85123a mixed</td>
<td>-96</td>
<td>2009-12-01 10:52:00</td>
<td>0.00</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">283</td>
<td>489463</td>
<td>71477</td>
<td>short</td>
<td>-240</td>
<td>2009-12-01 10:52:00</td>
<td>0.00</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">284</td>
<td>489467</td>
<td>85123A</td>
<td>21733 mixed</td>
<td>-192</td>
<td>2009-12-01 10:53:00</td>
<td>0.00</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">577</td>
<td>489525</td>
<td>85226C</td>
<td>BLUE PULL BACK RACING CAR</td>
<td>1</td>
<td>2009-12-01 11:49:00</td>
<td>0.55</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">578</td>
<td>489525</td>
<td>85227</td>
<td>SET/6 3D KIT CARDS FOR KIDS</td>
<td>1</td>
<td>2009-12-01 11:49:00</td>
<td>0.85</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">541536</td>
<td>581498</td>
<td>85099B</td>
<td>JUMBO BAG RED RETROSPOT</td>
<td>5</td>
<td>2011-12-09 10:26:00</td>
<td>4.13</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">541537</td>
<td>581498</td>
<td>85099C</td>
<td>JUMBO BAG BAROQUE BLACK WHITE</td>
<td>4</td>
<td>2011-12-09 10:26:00</td>
<td>4.13</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">541538</td>
<td>581498</td>
<td>85150</td>
<td>LADIES &amp; GENTLEMEN METAL SIGN</td>
<td>1</td>
<td>2011-12-09 10:26:00</td>
<td>4.96</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">541539</td>
<td>581498</td>
<td>85174</td>
<td>S/4 CACTI CANDLES</td>
<td>1</td>
<td>2011-12-09 10:26:00</td>
<td>10.79</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">541540</td>
<td>581498</td>
<td>DOT</td>
<td>DOTCOM POSTAGE</td>
<td>1</td>
<td>2011-12-09 10:26:00</td>
<td>1714.17</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
</tbody>
</table>

<p>238625 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>data.iloc[<span class="dv">575</span>:, :]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Invoice</th>
<th data-quarto-table-cell-role="th">StockCode</th>
<th data-quarto-table-cell-role="th">Description</th>
<th data-quarto-table-cell-role="th">Quantity</th>
<th data-quarto-table-cell-role="th">InvoiceDate</th>
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">Country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">576</td>
<td>C489524</td>
<td>21258</td>
<td>VICTORIAN SEWING BOX LARGE</td>
<td>-1</td>
<td>2009-12-01 11:48:00</td>
<td>12.75</td>
<td>15614.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">577</td>
<td>489525</td>
<td>85226C</td>
<td>BLUE PULL BACK RACING CAR</td>
<td>1</td>
<td>2009-12-01 11:49:00</td>
<td>0.55</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">578</td>
<td>489525</td>
<td>85227</td>
<td>SET/6 3D KIT CARDS FOR KIDS</td>
<td>1</td>
<td>2009-12-01 11:49:00</td>
<td>0.85</td>
<td>NaN</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">579</td>
<td>489526</td>
<td>85049E</td>
<td>SCANDINAVIAN REDS RIBBONS</td>
<td>12</td>
<td>2009-12-01 11:50:00</td>
<td>1.25</td>
<td>12533.0</td>
<td>Germany</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">580</td>
<td>489526</td>
<td>21976</td>
<td>PACK OF 60 MUSHROOM CAKE CASES</td>
<td>24</td>
<td>2009-12-01 11:50:00</td>
<td>0.55</td>
<td>12533.0</td>
<td>Germany</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">541905</td>
<td>581587</td>
<td>22899</td>
<td>CHILDREN'S APRON DOLLY GIRL</td>
<td>6</td>
<td>2011-12-09 12:50:00</td>
<td>2.10</td>
<td>12680.0</td>
<td>France</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">541906</td>
<td>581587</td>
<td>23254</td>
<td>CHILDRENS CUTLERY DOLLY GIRL</td>
<td>4</td>
<td>2011-12-09 12:50:00</td>
<td>4.15</td>
<td>12680.0</td>
<td>France</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">541907</td>
<td>581587</td>
<td>23255</td>
<td>CHILDRENS CUTLERY CIRCUS PARADE</td>
<td>4</td>
<td>2011-12-09 12:50:00</td>
<td>4.15</td>
<td>12680.0</td>
<td>France</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">541908</td>
<td>581587</td>
<td>22138</td>
<td>BAKING SET 9 PIECE RETROSPOT</td>
<td>3</td>
<td>2011-12-09 12:50:00</td>
<td>4.95</td>
<td>12680.0</td>
<td>France</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">541909</td>
<td>581587</td>
<td>POST</td>
<td>POSTAGE</td>
<td>1</td>
<td>2011-12-09 12:50:00</td>
<td>18.00</td>
<td>12680.0</td>
<td>France</td>
</tr>
</tbody>
</table>

<p>1062414 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We have to drop the rows where customer ID is null because it's a unique customer ID of each customer</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># So it's better to drop rather than imputing it with some random value</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>data.dropna(axis <span class="op">=</span> <span class="dv">0</span>, subset <span class="op">=</span> [<span class="st">"Customer ID"</span>], inplace <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>data.isnull().<span class="bu">sum</span>() <span class="co">#Now's there is no null values available in our data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Invoice        0
StockCode      0
Description    0
Quantity       0
InvoiceDate    0
Price          0
Customer ID    0
Country        0
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>data.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Invoice</th>
<th data-quarto-table-cell-role="th">StockCode</th>
<th data-quarto-table-cell-role="th">Description</th>
<th data-quarto-table-cell-role="th">Quantity</th>
<th data-quarto-table-cell-role="th">InvoiceDate</th>
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">Country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>489434</td>
<td>85048</td>
<td>15CM CHRISTMAS GLASS BALL 20 LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.95</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>489434</td>
<td>79323P</td>
<td>PINK CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>489434</td>
<td>79323W</td>
<td>WHITE CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>489434</td>
<td>22041</td>
<td>RECORD FRAME 7" SINGLE SIZE</td>
<td>48</td>
<td>2009-12-01 07:45:00</td>
<td>2.10</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>489434</td>
<td>21232</td>
<td>STRAWBERRY CERAMIC TRINKET BOX</td>
<td>24</td>
<td>2009-12-01 07:45:00</td>
<td>1.25</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>489434</td>
<td>22064</td>
<td>PINK DOUGHNUT TRINKET POT</td>
<td>24</td>
<td>2009-12-01 07:45:00</td>
<td>1.65</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>489434</td>
<td>21871</td>
<td>SAVE THE PLANET MUG</td>
<td>24</td>
<td>2009-12-01 07:45:00</td>
<td>1.25</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>489434</td>
<td>21523</td>
<td>FANCY FONT HOME SWEET HOME DOORMAT</td>
<td>10</td>
<td>2009-12-01 07:45:00</td>
<td>5.95</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>489435</td>
<td>22350</td>
<td>CAT BOWL</td>
<td>12</td>
<td>2009-12-01 07:46:00</td>
<td>2.55</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>489435</td>
<td>22349</td>
<td>DOG BOWL , CHASING BALL DESIGN</td>
<td>12</td>
<td>2009-12-01 07:46:00</td>
<td>3.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>temp_df <span class="op">=</span> pd.DataFrame(data[<span class="st">"Country"</span>].value_counts())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>temp_df.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Country</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">United Kingdom</td>
<td>741301</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Germany</td>
<td>17624</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">EIRE</td>
<td>16195</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">France</td>
<td>14202</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Netherlands</td>
<td>5140</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Spain</td>
<td>3811</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Belgium</td>
<td>3123</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Switzerland</td>
<td>3064</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Portugal</td>
<td>2504</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Australia</td>
<td>1913</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>names  <span class="op">=</span> temp_df.index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-scrolled="true" data-execution_count="24">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>plot_df <span class="op">=</span> temp_df.reset_index()</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>px.bar(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    plot_df,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"count"</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"Country"</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    orientation<span class="op">=</span><span class="st">"h"</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Country Occurrence in Dataset"</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>As you can see the <strong>United Kingdom</strong> has the max transcations as compared to other countries. The one here to note is that the <strong>“United Kingdom”</strong> is the dominating class in this data which making our data looks kinda imbalanced between major class and the minority class.</p>
<p>You can cross check the same after de-selecting the <strong>United Kingdom</strong> from the above chart and see how your axis transforms.</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's check the total quantity and by country</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>data.groupby(<span class="st">"Country"</span>)[<span class="st">"Quantity"</span>].<span class="bu">sum</span>().sort_values(ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># data.groupby("Country")["Quantity"].sum().sort_values(ascending=False).tail(10)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Country
United Kingdom    8353502
Netherlands        381951
EIRE               313373
Denmark            235218
Germany            224581
France             183339
Australia          103706
Sweden              87737
Switzerland         51831
Spain               45156
Name: Quantity, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>px.scatter(data.iloc[:, [<span class="dv">5</span>, <span class="dv">7</span>]].groupby([<span class="st">"Country"</span>]).mean(), </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>           y <span class="op">=</span> <span class="st">"Price"</span>, size <span class="op">=</span> <span class="st">"Price"</span>, title <span class="op">=</span> <span class="st">"Average Price by Country"</span>, opacity <span class="op">=</span> <span class="fl">0.48</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>From the above dot plot we can conclude that the <strong>Singapore</strong> has the highest averge price followed by the <strong>Norway</strong> and <strong>Malta</strong>. Let’s go deeper and see the distribution to better understand about our data.</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>countries <span class="op">=</span> data[<span class="st">"Country"</span>].unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plotting the violin plot for the data sample</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">11</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">14</span>))</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>axes_ <span class="op">=</span> ax.ravel()</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>max_plots <span class="op">=</span> <span class="bu">len</span>(axes_)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, c <span class="kw">in</span> <span class="bu">enumerate</span>(countries[:max_plots]):</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.loc[data[<span class="st">"Country"</span>] <span class="op">==</span> c, [<span class="st">"Price"</span>]].dropna()</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">&gt;</span> <span class="dv">5000</span>:</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.sample(<span class="dv">5000</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    sns.violinplot(x<span class="op">=</span><span class="st">"Price"</span>, data<span class="op">=</span>df, ax<span class="op">=</span>axes_[i], inner<span class="op">=</span><span class="st">"point"</span>)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    axes_[i].set_title(<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss"> Price Distribution"</span>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 多余子图关掉</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, max_plots):</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    axes_[j].axis(<span class="st">"off"</span>)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-27-output-1.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) 计算每个国家的排序指标（默认：Price 的中位数）</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>country_rank <span class="op">=</span> (</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    data.dropna(subset<span class="op">=</span>[<span class="st">"Country"</span>, <span class="st">"Price"</span>])</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"Country"</span>)[<span class="st">"Price"</span>]</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    .median()  <span class="co"># &lt;- 想换成 max/mean/p95 就改这里</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    .sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>top20_countries <span class="op">=</span> country_rank.head(<span class="dv">20</span>).index.tolist()</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) 为了性能与一致性，先过滤出 top20 的全量数据（不抽样）</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>df_top20 <span class="op">=</span> data.loc[data[<span class="st">"Country"</span>].isin(top20_countries)].dropna(</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"Price"</span>, <span class="st">"Country"</span>]</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) 画图：20 个国家，建议 5x4 或 4x5</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(top20_countries)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>ncols <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>nrows <span class="op">=</span> <span class="bu">int</span>(np.ceil(n <span class="op">/</span> ncols))</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows, ncols, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="fl">1.6</span> <span class="op">*</span> nrows))</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>axes_ <span class="op">=</span> ax.ravel()</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, c <span class="kw">in</span> <span class="bu">enumerate</span>(top20_countries):</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    sns.violinplot(</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Price"</span>,</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>df_top20[df_top20[<span class="st">"Country"</span>] <span class="op">==</span> c],</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>axes_[i],</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>        inner<span class="op">=</span><span class="st">"point"</span>,</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># palette="pastel",  # 单变量不需要 palette；如要统一颜色可以用 color=</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>    axes_[i].set_title(<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss"> Price Distribution"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>    axes_[i].set_xlabel(<span class="st">"Price"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) 多余子图关掉</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(axes_)):</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>    axes_[j].axis(<span class="st">"off"</span>)</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-28-output-1.svg" class="img-fluid"></p>
</div>
</div>
<p>From the above plot what I can interpret is that most of the data is pretty skewed and there is lot’s of high extreme values that are present in the data.</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Total Number of Unique Invoices </span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(data[<span class="st">"Invoice"</span>].unique())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>44876</code></pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>temp_invoice_df <span class="op">=</span> data.groupby(<span class="st">"Invoice"</span>).<span class="bu">sum</span>(numeric_only<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>temp_invoice_df.reset_index(inplace <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Below are the top 30 invoices with total quantity purchased by them</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>temp_invoice_df.sort_values(by <span class="op">=</span> <span class="st">"Quantity"</span>, ascending <span class="op">=</span> <span class="va">False</span>).head(<span class="dv">30</span>).iloc[:,:<span class="dv">2</span>].style.background_gradient(cmap <span class="op">=</span> <span class="st">"Blues"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_09610_row0_col1, #T_09610_row1_col1 {
  background-color: #08306b;
  color: #f1f1f1;
}
#T_09610_row2_col1 {
  background-color: #083b7c;
  color: #f1f1f1;
}
#T_09610_row3_col1 {
  background-color: #08458a;
  color: #f1f1f1;
}
#T_09610_row4_col1 {
  background-color: #105ba4;
  color: #f1f1f1;
}
#T_09610_row5_col1 {
  background-color: #2e7ebc;
  color: #f1f1f1;
}
#T_09610_row6_col1 {
  background-color: #3181bd;
  color: #f1f1f1;
}
#T_09610_row7_col1 {
  background-color: #99c7e0;
  color: #000000;
}
#T_09610_row8_col1 {
  background-color: #d1e2f3;
  color: #000000;
}
#T_09610_row9_col1 {
  background-color: #dceaf6;
  color: #000000;
}
#T_09610_row10_col1 {
  background-color: #e3eef9;
  color: #000000;
}
#T_09610_row11_col1 {
  background-color: #e4eff9;
  color: #000000;
}
#T_09610_row12_col1 {
  background-color: #e9f2fa;
  color: #000000;
}
#T_09610_row13_col1 {
  background-color: #eaf3fb;
  color: #000000;
}
#T_09610_row14_col1 {
  background-color: #ebf3fb;
  color: #000000;
}
#T_09610_row15_col1 {
  background-color: #eef5fc;
  color: #000000;
}
#T_09610_row16_col1, #T_09610_row17_col1, #T_09610_row18_col1 {
  background-color: #f0f6fd;
  color: #000000;
}
#T_09610_row19_col1, #T_09610_row20_col1, #T_09610_row21_col1 {
  background-color: #f1f7fd;
  color: #000000;
}
#T_09610_row22_col1, #T_09610_row23_col1 {
  background-color: #f2f7fd;
  color: #000000;
}
#T_09610_row24_col1, #T_09610_row25_col1, #T_09610_row26_col1 {
  background-color: #f2f8fd;
  color: #000000;
}
#T_09610_row27_col1 {
  background-color: #f5f9fe;
  color: #000000;
}
#T_09610_row28_col1, #T_09610_row29_col1 {
  background-color: #f7fbff;
  color: #000000;
}
</style>

<table id="T_09610" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_09610_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Invoice</th>
<th id="T_09610_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Quantity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_09610_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">11080</td>
<td id="T_09610_row0_col0" class="data row0 col0">518505</td>
<td id="T_09610_row0_col1" class="data row0 col1">87167</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">13425</td>
<td id="T_09610_row1_col0" class="data row1 col0">524174</td>
<td id="T_09610_row1_col1" class="data row1 col1">87167</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">3064</td>
<td id="T_09610_row2_col0" class="data row2 col0">497946</td>
<td id="T_09610_row2_col1" class="data row2 col1">83774</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">36942</td>
<td id="T_09610_row3_col0" class="data row3 col0">581483</td>
<td id="T_09610_row3_col1" class="data row3 col1">80995</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">20348</td>
<td id="T_09610_row4_col0" class="data row4 col0">541431</td>
<td id="T_09610_row4_col1" class="data row4 col1">74215</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row5" class="row_heading level0 row5" data-quarto-table-cell-role="th">4379</td>
<td id="T_09610_row5_col0" class="data row5 col0">501534</td>
<td id="T_09610_row5_col1" class="data row5 col1">63974</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">2096</td>
<td id="T_09610_row6_col0" class="data row6 col0">495194</td>
<td id="T_09610_row6_col1" class="data row6 col1">63302</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row7" class="row_heading level0 row7" data-quarto-table-cell-role="th">4693</td>
<td id="T_09610_row7_col0" class="data row7 col0">502269</td>
<td id="T_09610_row7_col1" class="data row7 col1">40000</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row8" class="row_heading level0 row8" data-quarto-table-cell-role="th">1604</td>
<td id="T_09610_row8_col0" class="data row8 col0">493819</td>
<td id="T_09610_row8_col1" class="data row8 col1">25018</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row9" class="row_heading level0 row9" data-quarto-table-cell-role="th">1047</td>
<td id="T_09610_row9_col0" class="data row9 col0">491812</td>
<td id="T_09610_row9_col1" class="data row9 col1">20524</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row10" class="row_heading level0 row10" data-quarto-table-cell-role="th">7529</td>
<td id="T_09610_row10_col0" class="data row10 col0">509472</td>
<td id="T_09610_row10_col1" class="data row10 col1">17766</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row11" class="row_heading level0 row11" data-quarto-table-cell-role="th">246</td>
<td id="T_09610_row11_col0" class="data row11 col0">490018</td>
<td id="T_09610_row11_col1" class="data row11 col1">17520</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row12" class="row_heading level0 row12" data-quarto-table-cell-role="th">16097</td>
<td id="T_09610_row12_col0" class="data row12 col0">530715</td>
<td id="T_09610_row12_col1" class="data row12 col1">15696</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row13" class="row_heading level0 row13" data-quarto-table-cell-role="th">26551</td>
<td id="T_09610_row13_col0" class="data row13 col0">556917</td>
<td id="T_09610_row13_col1" class="data row13 col1">15049</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row14" class="row_heading level0 row14" data-quarto-table-cell-role="th">29051</td>
<td id="T_09610_row14_col0" class="data row14 col0">563076</td>
<td id="T_09610_row14_col1" class="data row14 col1">14730</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row15" class="row_heading level0 row15" data-quarto-table-cell-role="th">32810</td>
<td id="T_09610_row15_col0" class="data row15 col0">572035</td>
<td id="T_09610_row15_col1" class="data row15 col1">13392</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row16" class="row_heading level0 row16" data-quarto-table-cell-role="th">12179</td>
<td id="T_09610_row16_col0" class="data row16 col0">521315</td>
<td id="T_09610_row16_col1" class="data row16 col1">13008</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row17" class="row_heading level0 row17" data-quarto-table-cell-role="th">14557</td>
<td id="T_09610_row17_col0" class="data row17 col0">526761</td>
<td id="T_09610_row17_col1" class="data row17 col1">12954</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row18" class="row_heading level0 row18" data-quarto-table-cell-role="th">2252</td>
<td id="T_09610_row18_col0" class="data row18 col0">495591</td>
<td id="T_09610_row18_col1" class="data row18 col1">12832</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row19" class="row_heading level0 row19" data-quarto-table-cell-role="th">30858</td>
<td id="T_09610_row19_col0" class="data row19 col0">567423</td>
<td id="T_09610_row19_col1" class="data row19 col1">12572</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row20" class="row_heading level0 row20" data-quarto-table-cell-role="th">35799</td>
<td id="T_09610_row20_col0" class="data row20 col0">578841</td>
<td id="T_09610_row20_col1" class="data row20 col1">12540</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row21" class="row_heading level0 row21" data-quarto-table-cell-role="th">7239</td>
<td id="T_09610_row21_col0" class="data row21 col0">508748</td>
<td id="T_09610_row21_col1" class="data row21 col1">12500</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row22" class="row_heading level0 row22" data-quarto-table-cell-role="th">24876</td>
<td id="T_09610_row22_col0" class="data row22 col0">552883</td>
<td id="T_09610_row22_col1" class="data row22 col1">12266</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row23" class="row_heading level0 row23" data-quarto-table-cell-role="th">29282</td>
<td id="T_09610_row23_col0" class="data row23 col0">563614</td>
<td id="T_09610_row23_col1" class="data row23 col1">12196</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row24" class="row_heading level0 row24" data-quarto-table-cell-role="th">18296</td>
<td id="T_09610_row24_col0" class="data row24 col0">536009</td>
<td id="T_09610_row24_col1" class="data row24 col1">12048</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row25" class="row_heading level0 row25" data-quarto-table-cell-role="th">11136</td>
<td id="T_09610_row25_col0" class="data row25 col0">518673</td>
<td id="T_09610_row25_col1" class="data row25 col1">11904</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row26" class="row_heading level0 row26" data-quarto-table-cell-role="th">28783</td>
<td id="T_09610_row26_col0" class="data row26 col0">562439</td>
<td id="T_09610_row26_col1" class="data row26 col1">11848</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row27" class="row_heading level0 row27" data-quarto-table-cell-role="th">22980</td>
<td id="T_09610_row27_col0" class="data row27 col0">548011</td>
<td id="T_09610_row27_col1" class="data row27 col1">11116</td>
</tr>
<tr class="odd">
<td id="T_09610_level0_row28" class="row_heading level0 row28" data-quarto-table-cell-role="th">21933</td>
<td id="T_09610_row28_col0" class="data row28 col0">545475</td>
<td id="T_09610_row28_col1" class="data row28 col1">10272</td>
</tr>
<tr class="even">
<td id="T_09610_level0_row29" class="row_heading level0 row29" data-quarto-table-cell-role="th">17933</td>
<td id="T_09610_row29_col0" class="data row29 col0">535104</td>
<td id="T_09610_row29_col1" class="data row29 col1">10014</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert Price to numeric (coerce invalid values to NaN), then compute mean Price per Invoice and get top 15</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"Price"</span>] <span class="op">=</span> pd.to_numeric(data[<span class="st">"Price"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>top15 <span class="op">=</span> (</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    data.groupby(<span class="st">"Invoice"</span>, as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">"Price"</span>]</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"Price"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    .head(<span class="dv">15</span>)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>top15</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Invoice</th>
<th data-quarto-table-cell-role="th">Price</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">42923</td>
<td>C556445</td>
<td>38970.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">39136</td>
<td>C512770</td>
<td>25111.09</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38141</td>
<td>C502264</td>
<td>10953.50</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4689</td>
<td>502263</td>
<td>10953.50</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38140</td>
<td>C502262</td>
<td>10953.50</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13417</td>
<td>524159</td>
<td>10468.80</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">40016</td>
<td>C522793</td>
<td>10468.80</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">40254</td>
<td>C525398</td>
<td>10468.80</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">37621</td>
<td>C496116</td>
<td>8985.60</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2444</td>
<td>496115</td>
<td>8985.60</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42534</td>
<td>C551685</td>
<td>8142.75</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">24361</td>
<td>551697</td>
<td>8142.75</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">40266</td>
<td>C525470</td>
<td>7044.79</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4500</td>
<td>501766</td>
<td>6958.17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4502</td>
<td>501768</td>
<td>6958.17</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>I have grouped the data by Invoice to see the average spend by Invoice Number. Here one thing interesting to see that the invoice with number <strong>489444</strong> &amp; <strong>489447</strong> has outspent others. So to gain some better clarity, let’s check these 2 invoices and get insights on how much quantity they have purchased so far.</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>data[(data[<span class="st">"Invoice"</span>] <span class="op">==</span> <span class="dv">489444</span>) <span class="op">|</span> (data[<span class="st">"Invoice"</span>] <span class="op">==</span> <span class="dv">489447</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Invoice</th>
<th data-quarto-table-cell-role="th">StockCode</th>
<th data-quarto-table-cell-role="th">Description</th>
<th data-quarto-table-cell-role="th">Quantity</th>
<th data-quarto-table-cell-role="th">InvoiceDate</th>
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">Country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">126</td>
<td>489444</td>
<td>POST</td>
<td>POSTAGE</td>
<td>1</td>
<td>2009-12-01 09:55:00</td>
<td>141.0</td>
<td>12636.0</td>
<td>USA</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">173</td>
<td>489447</td>
<td>POST</td>
<td>POSTAGE</td>
<td>1</td>
<td>2009-12-01 10:10:00</td>
<td>130.0</td>
<td>12362.0</td>
<td>Belgium</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As you can see above, These 2 invoices with invoice number <strong>489444</strong> and <strong>489447</strong> had only single transaction, that’s why the average price was too high.</p>
</section>
<section id="initial-eda-insights" class="level3">
<h3 class="anchored" data-anchor-id="initial-eda-insights"><strong>INITIAL EDA INSIGHTS:</strong></h3>
<ol type="1">
<li><p>Most of the customers are from the United Kingdom followed by the Germany, EIRE &amp; France.</p></li>
<li><p>If we check the average price sale by countries, what we have observed is that Singapore has the highest averge price sale followed by the Norway and Malta.</p></li>
<li><p>Most of the countries data is skewed when it comes to the Price feature with lots of higher extreme values.</p></li>
<li><p>There are total 44876 uniques purchased happend so far.</p></li>
<li><p>We have also observed some of the Invoices who have purchased most of the quantities within 2 year of span.</p></li>
<li><p>When it comes to the average spend there are 2 invoices with number 489444 and 489447 having the highest average spent but upon inspection we also found the average product purchase was only 1 which is from USA followed by Belgium.</p></li>
</ol>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Let's look at the data once again &amp; see what else insights we can get from the data itself</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>data.head(<span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Invoice</th>
<th data-quarto-table-cell-role="th">StockCode</th>
<th data-quarto-table-cell-role="th">Description</th>
<th data-quarto-table-cell-role="th">Quantity</th>
<th data-quarto-table-cell-role="th">InvoiceDate</th>
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">Country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>489434</td>
<td>85048</td>
<td>15CM CHRISTMAS GLASS BALL 20 LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.95</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>489434</td>
<td>79323P</td>
<td>PINK CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>489434</td>
<td>79323W</td>
<td>WHITE CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>489434</td>
<td>22041</td>
<td>RECORD FRAME 7" SINGLE SIZE</td>
<td>48</td>
<td>2009-12-01 07:45:00</td>
<td>2.10</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>489434</td>
<td>21232</td>
<td>STRAWBERRY CERAMIC TRINKET BOX</td>
<td>24</td>
<td>2009-12-01 07:45:00</td>
<td>1.25</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>489434</td>
<td>22064</td>
<td>PINK DOUGHNUT TRINKET POT</td>
<td>24</td>
<td>2009-12-01 07:45:00</td>
<td>1.65</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>489434</td>
<td>21871</td>
<td>SAVE THE PLANET MUG</td>
<td>24</td>
<td>2009-12-01 07:45:00</td>
<td>1.25</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>489434</td>
<td>21523</td>
<td>FANCY FONT HOME SWEET HOME DOORMAT</td>
<td>10</td>
<td>2009-12-01 07:45:00</td>
<td>5.95</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>489435</td>
<td>22350</td>
<td>CAT BOWL</td>
<td>12</td>
<td>2009-12-01 07:46:00</td>
<td>2.55</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>489435</td>
<td>22349</td>
<td>DOG BOWL , CHASING BALL DESIGN</td>
<td>12</td>
<td>2009-12-01 07:46:00</td>
<td>3.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>489435</td>
<td>22195</td>
<td>HEART MEASURING SPOONS LARGE</td>
<td>24</td>
<td>2009-12-01 07:46:00</td>
<td>1.65</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>489435</td>
<td>22353</td>
<td>LUNCHBOX WITH CUTLERY FAIRY CAKES</td>
<td>12</td>
<td>2009-12-01 07:46:00</td>
<td>2.55</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>489436</td>
<td>48173C</td>
<td>DOOR MAT BLACK FLOCK</td>
<td>10</td>
<td>2009-12-01 09:06:00</td>
<td>5.95</td>
<td>13078.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>489436</td>
<td>21755</td>
<td>LOVE BUILDING BLOCK WORD</td>
<td>18</td>
<td>2009-12-01 09:06:00</td>
<td>5.45</td>
<td>13078.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>489436</td>
<td>21754</td>
<td>HOME BUILDING BLOCK WORD</td>
<td>3</td>
<td>2009-12-01 09:06:00</td>
<td>5.95</td>
<td>13078.0</td>
<td>United Kingdom</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="exploratory-data-analysis-continued.." class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis-continued.."><strong>Exploratory Data Analysis Continued…..</strong></h3>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Let's check which product has been purchased more often so far</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"Quantity"</span>] <span class="op">=</span> (</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    pd.to_numeric(data[<span class="st">"Quantity"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    data.groupby(<span class="st">"Description"</span>)[<span class="st">"Quantity"</span>]</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    .sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    .head(<span class="dv">30</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    .plot(kind<span class="op">=</span><span class="st">"bar"</span>, color<span class="op">=</span><span class="st">"mediumseagreen"</span>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: xlabel='Description'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-36-output-2.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>temp_data <span class="op">=</span> data.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>temp_data.head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Invoice</th>
<th data-quarto-table-cell-role="th">StockCode</th>
<th data-quarto-table-cell-role="th">Description</th>
<th data-quarto-table-cell-role="th">Quantity</th>
<th data-quarto-table-cell-role="th">InvoiceDate</th>
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">Country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>489434</td>
<td>85048</td>
<td>15CM CHRISTMAS GLASS BALL 20 LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.95</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>489434</td>
<td>79323P</td>
<td>PINK CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>489434</td>
<td>79323W</td>
<td>WHITE CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>489434</td>
<td>22041</td>
<td>RECORD FRAME 7" SINGLE SIZE</td>
<td>48</td>
<td>2009-12-01 07:45:00</td>
<td>2.10</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>489434</td>
<td>21232</td>
<td>STRAWBERRY CERAMIC TRINKET BOX</td>
<td>24</td>
<td>2009-12-01 07:45:00</td>
<td>1.25</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Date Time Analysis</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>temp_data.loc[:, <span class="st">"Month"</span>] <span class="op">=</span> data.InvoiceDate.dt.month</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>temp_data.loc[:, <span class="st">"Time"</span>] <span class="op">=</span> data.InvoiceDate.dt.time</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>temp_data.loc[:, <span class="st">"Year"</span>] <span class="op">=</span> data.InvoiceDate.dt.year</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>temp_data.loc[:, <span class="st">"Day"</span>] <span class="op">=</span> data.InvoiceDate.dt.day</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>temp_data.loc[:, <span class="st">"Quarter"</span>] <span class="op">=</span> data.InvoiceDate.dt.quarter</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>temp_data.loc[:, <span class="st">"Day of Week"</span>] <span class="op">=</span> data.InvoiceDate.dt.dayofweek</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Mapping day of week</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>dayofweek_mapping <span class="op">=</span> <span class="bu">dict</span>({<span class="dv">0</span>: <span class="st">"Monday"</span>, </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                         <span class="dv">1</span>: <span class="st">"Tuesday"</span>, </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>                         <span class="dv">2</span>: <span class="st">"Wednesday"</span> , </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>                         <span class="dv">3</span>: <span class="st">"Thursday"</span>, </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>                         <span class="dv">4</span>: <span class="st">"Friday"</span>, </span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>                         <span class="dv">5</span>: <span class="st">"Saturday"</span>, </span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>                         <span class="dv">6</span>: <span class="st">"Sunday"</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>temp_data[<span class="st">"Day of Week"</span>] <span class="op">=</span> temp_data[<span class="st">"Day of Week"</span>].<span class="bu">map</span>(dayofweek_mapping) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the above data</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">9</span>))</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>month_qty <span class="op">=</span> temp_data.groupby(<span class="st">"Month"</span>)[<span class="st">"Quantity"</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"Month"</span>, y<span class="op">=</span><span class="st">"Quantity"</span>, data<span class="op">=</span>month_qty, marker<span class="op">=</span><span class="st">"o"</span>, color<span class="op">=</span><span class="st">"lightseagreen"</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="dv">11</span>, color<span class="op">=</span><span class="st">"k"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>plt.text(<span class="fl">8.50</span>, <span class="fl">1.3e6</span>, <span class="st">"Most Transactions"</span>)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Transactions by Month"</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>year_qty <span class="op">=</span> temp_data.groupby(<span class="st">"Year"</span>)[<span class="st">"Quantity"</span>].<span class="bu">sum</span>()</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>year_qty.plot(kind<span class="op">=</span><span class="st">"bar"</span>)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Transactions by Year"</span>)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>quarter_qty <span class="op">=</span> temp_data.groupby(<span class="st">"Quarter"</span>)[<span class="st">"Quantity"</span>].<span class="bu">sum</span>()</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>quarter_qty.plot(kind<span class="op">=</span><span class="st">"bar"</span>, color<span class="op">=</span><span class="st">"darkslategrey"</span>)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Transactions by Quarter"</span>)</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>day_qty <span class="op">=</span> temp_data.groupby(<span class="st">"Day"</span>)[<span class="st">"Quantity"</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"Day"</span>, y<span class="op">=</span><span class="st">"Quantity"</span>, data<span class="op">=</span>day_qty, marker<span class="op">=</span><span class="st">"o"</span>)</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="dv">7</span>, color<span class="op">=</span><span class="st">"r"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="dv">15</span>, color<span class="op">=</span><span class="st">"k"</span>, linestyle<span class="op">=</span><span class="st">"dotted"</span>)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Transactions by Day"</span>)</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">5</span>)</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>dow_qty <span class="op">=</span> temp_data.groupby(<span class="st">"Day of Week"</span>)[<span class="st">"Quantity"</span>].<span class="bu">sum</span>()</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>dow_qty.plot(kind<span class="op">=</span><span class="st">"bar"</span>, color<span class="op">=</span><span class="st">"darkorange"</span>)</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Transactions by Day of Week"</span>)</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-42-output-1.svg" class="img-fluid"></p>
</div>
</div>
<p>As we can see, in 2009 the transactions is quite low as compared to 2010 and 2011. But as if now, we don’t know the reason behind this so let’s investigate why 2009 is low as compared to other 2 years.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Total Number of Countries in 2009: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">len</span>(temp_data[temp_data[<span class="st">"Year"</span>] <span class="op">==</span> <span class="dv">2009</span>][<span class="st">"Country"</span>].unique())</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Total Number of Transactions in 2009: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>        temp_data[temp_data[<span class="st">"Year"</span>] <span class="op">==</span> <span class="dv">2009</span>][<span class="st">"Quantity"</span>].<span class="bu">sum</span>()</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"--------------------------------------------"</span>)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Total Number of Countries in 2009: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">len</span>(temp_data[temp_data[<span class="st">"Year"</span>] <span class="op">==</span> <span class="dv">2010</span>][<span class="st">"Country"</span>].unique())</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Total Number of Transactions in 2009: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>        temp_data[temp_data[<span class="st">"Year"</span>] <span class="op">==</span> <span class="dv">2010</span>][<span class="st">"Quantity"</span>].<span class="bu">sum</span>()</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"--------------------------------------------"</span>)</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Total Number of Countries in 2009: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">len</span>(temp_data[temp_data[<span class="st">"Year"</span>] <span class="op">==</span> <span class="dv">2011</span>][<span class="st">"Country"</span>].unique())</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Total Number of Transactions in 2009: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>        temp_data[temp_data[<span class="st">"Year"</span>] <span class="op">==</span> <span class="dv">2011</span>][<span class="st">"Quantity"</span>].<span class="bu">sum</span>()</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total Number of Countries in 2009: 23
Total Number of Transactions in 2009: 390286
--------------------------------------------
Total Number of Countries in 2009: 37
Total Number of Transactions in 2009: 5233315
--------------------------------------------
Total Number of Countries in 2009: 36
Total Number of Transactions in 2009: 4610527</code></pre>
</div>
</div>
<p>Through this analysis what conclusion we can make is that may be the company has started their operations in other countries and started to expand their business further.</p>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>_2009 <span class="op">=</span> temp_data[temp_data[<span class="st">"Year"</span>] <span class="op">==</span> <span class="dv">2009</span>][<span class="st">"Country"</span>].unique()</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>_2010 <span class="op">=</span> temp_data[temp_data[<span class="st">"Year"</span>] <span class="op">==</span> <span class="dv">2010</span>][<span class="st">"Country"</span>].unique()</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>_2011 <span class="op">=</span> temp_data[temp_data[<span class="st">"Year"</span>] <span class="op">==</span> <span class="dv">2011</span>][<span class="st">"Country"</span>].unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>no_cols <span class="op">=</span> []</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> (_2010):</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> _2009:</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>        no_cols.append(i)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"These are the values which are not present in 2009: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(no_cols))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>These are the values which are not present in 2009: ['Unspecified', 'Nigeria', 'Malta', 'RSA', 'Singapore', 'Bahrain', 'Thailand', 'Israel', 'Lithuania', 'West Indies', 'Korea', 'Brazil', 'Canada', 'Iceland']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>temp <span class="op">=</span> (</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    data.assign(Quantity<span class="op">=</span>pd.to_numeric(data[<span class="st">"Quantity"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>))</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"Country"</span>, <span class="st">"Description"</span>])[<span class="st">"Quantity"</span>]</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>temp <span class="op">=</span> pd.DataFrame(temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="top-8-countries-with-most-transactions" class="level3">
<h3 class="anchored" data-anchor-id="top-8-countries-with-most-transactions">Top 8 Countries With Most Transactions</h3>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>top_8_countries <span class="op">=</span> [<span class="st">"United Kingdom"</span>, <span class="st">"Netherlands"</span>, <span class="st">"EIRE"</span>, <span class="st">"Denmark"</span>, <span class="st">"Germany"</span>, <span class="st">"France"</span>, <span class="st">"Australia"</span>, <span class="st">"Sweden"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">24</span>))</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x, c <span class="kw">in</span> <span class="bu">enumerate</span>(top_8_countries):</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> plt.subplot(<span class="dv">4</span>,<span class="dv">2</span>, x<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    plt.title(c <span class="op">+</span> <span class="st">' '</span><span class="op">+</span> <span class="st">"Most Selling Products"</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    temp.loc[c].sort_values(by <span class="op">=</span> <span class="st">"Quantity"</span>, ascending <span class="op">=</span> <span class="va">False</span>)[<span class="st">"Quantity"</span>].head(<span class="dv">5</span>).plot(kind <span class="op">=</span> <span class="st">"bar"</span>, ax <span class="op">=</span> ax, color <span class="op">=</span> <span class="st">"teal"</span>, alpha <span class="op">=</span> <span class="fl">0.6</span>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-49-output-1.svg" class="img-fluid"></p>
</div>
</div>
</section>
<section id="top-8-countries-with-least-transactions" class="level3">
<h3 class="anchored" data-anchor-id="top-8-countries-with-least-transactions">Top 8 Countries with Least Transactions</h3>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>least_8_country <span class="op">=</span> [<span class="st">"Saudi Arabia"</span>, <span class="st">"Nigeria"</span>, <span class="st">"Lebanon"</span>, <span class="st">"West Indies"</span>, <span class="st">"European Community"</span>, <span class="st">"Brazil"</span>, <span class="st">"Czech Republic"</span>, <span class="st">"Korea"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">24</span>))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x, c <span class="kw">in</span> <span class="bu">enumerate</span>(least_8_country):</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> plt.subplot(<span class="dv">4</span>,<span class="dv">2</span>, x<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    plt.title(c <span class="op">+</span> <span class="st">' '</span><span class="op">+</span> <span class="st">"Most Selling Products"</span>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    temp.loc[c].sort_values(by <span class="op">=</span> <span class="st">"Quantity"</span>, ascending <span class="op">=</span> <span class="va">False</span>)[<span class="st">"Quantity"</span>].head(<span class="dv">5</span>).plot(kind <span class="op">=</span> <span class="st">"bar"</span>, ax <span class="op">=</span> ax, color <span class="op">=</span> <span class="st">"sandybrown"</span>, alpha <span class="op">=</span> <span class="fl">0.8</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-51-output-1.svg" class="img-fluid"></p>
</div>
</div>
</section>
<section id="eda-insights" class="level3">
<h3 class="anchored" data-anchor-id="eda-insights"><strong>EDA INSIGHTS:</strong></h3>
<ol type="1">
<li><p>Our Top 5 Best Selling Products are <strong>World War 2 Gliders</strong>, <strong>White Hanging Heart</strong>, <strong>Assorted Colour Bird</strong>, <strong>Jumbo Bag Red</strong>, <strong>Brocade Ring</strong>.</p></li>
<li><p>Most Transactions happened in the month of Novemeber which is evident due to festive seasons.</p></li>
<li><p>2010 is the year in which we have the most transactions followed by the 2011</p></li>
<li><p>Q4 being the highest when it comes transactions.</p></li>
<li><p>It also observed that in the end of the 1st week and starting of the 3rd week, people tends to buy more.</p></li>
<li><p>People loves to shop on Thursday followed by Tuesday and Wednesday.</p></li>
</ol>
</section>
<section id="rfm-estimation---recency-frequency-monetary" class="level3">
<h3 class="anchored" data-anchor-id="rfm-estimation---recency-frequency-monetary">RFM Estimation - (Recency, Frequency, Monetary)</h3>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Invoice</th>
<th data-quarto-table-cell-role="th">StockCode</th>
<th data-quarto-table-cell-role="th">Description</th>
<th data-quarto-table-cell-role="th">Quantity</th>
<th data-quarto-table-cell-role="th">InvoiceDate</th>
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">Country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>489434</td>
<td>85048</td>
<td>15CM CHRISTMAS GLASS BALL 20 LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.95</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>489434</td>
<td>79323P</td>
<td>PINK CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>489434</td>
<td>79323W</td>
<td>WHITE CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>489434</td>
<td>22041</td>
<td>RECORD FRAME 7" SINGLE SIZE</td>
<td>48</td>
<td>2009-12-01 07:45:00</td>
<td>2.10</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>489434</td>
<td>21232</td>
<td>STRAWBERRY CERAMIC TRINKET BOX</td>
<td>24</td>
<td>2009-12-01 07:45:00</td>
<td>1.25</td>
<td>13085.0</td>
<td>United Kingdom</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"Total Amount"</span>] <span class="op">=</span> data[<span class="st">"Quantity"</span>]<span class="op">*</span>data[<span class="st">"Price"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Invoice</th>
<th data-quarto-table-cell-role="th">StockCode</th>
<th data-quarto-table-cell-role="th">Description</th>
<th data-quarto-table-cell-role="th">Quantity</th>
<th data-quarto-table-cell-role="th">InvoiceDate</th>
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">Country</th>
<th data-quarto-table-cell-role="th">Total Amount</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>489434</td>
<td>85048</td>
<td>15CM CHRISTMAS GLASS BALL 20 LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.95</td>
<td>13085.0</td>
<td>United Kingdom</td>
<td>83.4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>489434</td>
<td>79323P</td>
<td>PINK CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
<td>81.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>489434</td>
<td>79323W</td>
<td>WHITE CHERRY LIGHTS</td>
<td>12</td>
<td>2009-12-01 07:45:00</td>
<td>6.75</td>
<td>13085.0</td>
<td>United Kingdom</td>
<td>81.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>489434</td>
<td>22041</td>
<td>RECORD FRAME 7" SINGLE SIZE</td>
<td>48</td>
<td>2009-12-01 07:45:00</td>
<td>2.10</td>
<td>13085.0</td>
<td>United Kingdom</td>
<td>100.8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>489434</td>
<td>21232</td>
<td>STRAWBERRY CERAMIC TRINKET BOX</td>
<td>24</td>
<td>2009-12-01 07:45:00</td>
<td>1.25</td>
<td>13085.0</td>
<td>United Kingdom</td>
<td>30.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lifetimes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>rfm_summary <span class="op">=</span> lifetimes.utils.summary_data_from_transaction_data(data, <span class="st">"Customer ID"</span>, <span class="st">"InvoiceDate"</span>, <span class="st">"Total Amount"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>rfm_summary.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">recency</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">monetary_value</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">12346.0</td>
<td>10.0</td>
<td>400.0</td>
<td>725.0</td>
<td>-15.468000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12347.0</td>
<td>7.0</td>
<td>402.0</td>
<td>404.0</td>
<td>717.398571</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12348.0</td>
<td>4.0</td>
<td>363.0</td>
<td>438.0</td>
<td>449.310000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12349.0</td>
<td>4.0</td>
<td>717.0</td>
<td>735.0</td>
<td>1107.172500</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12350.0</td>
<td>0.0</td>
<td>0.0</td>
<td>310.0</td>
<td>0.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>rfm_summary.reset_index(inplace <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plotting the distribution</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">221</span>)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>sns.distplot(rfm_summary[<span class="st">"frequency"</span>])</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Frequency Distribution"</span>)</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">222</span>)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>sns.distplot(rfm_summary[<span class="st">"recency"</span>])</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Recency Distribution"</span>)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">223</span>)</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>sns.distplot(rfm_summary[<span class="st">"T"</span>])</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"T Distribution"</span>)</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">224</span>)</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>sns.distplot(rfm_summary[<span class="st">"monetary_value"</span>])</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Monetary Value Distribution"</span>)</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-59-output-1.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">5</span>))</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">141</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>sns.boxplot(rfm_summary[<span class="st">"frequency"</span>], color <span class="op">=</span> <span class="st">"olive"</span>)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Frequency"</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">142</span>)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>sns.boxplot(rfm_summary[<span class="st">"recency"</span>])</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Recency"</span>)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">143</span>)</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>sns.boxplot(rfm_summary[<span class="st">"T"</span>])</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"T"</span>)</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">144</span>)</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>sns.boxplot(rfm_summary[<span class="st">"monetary_value"</span>], color <span class="op">=</span> <span class="st">"salmon"</span>)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-60-output-1.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>rfm_summary.describe(percentiles <span class="op">=</span> [<span class="fl">0.01</span>,<span class="fl">0.1</span>,<span class="fl">0.25</span>,<span class="fl">0.50</span>,<span class="fl">0.75</span>,<span class="fl">0.90</span>,<span class="fl">0.99</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">recency</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">monetary_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>5942.000000</td>
<td>5942.000000</td>
<td>5942.000000</td>
<td>5942.000000</td>
<td>5942.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>15316.500000</td>
<td>5.479636</td>
<td>275.772299</td>
<td>478.229384</td>
<td>228.814496</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>1715.451981</td>
<td>11.293673</td>
<td>259.830840</td>
<td>223.879537</td>
<td>363.067124</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>12346.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>-3610.500000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1%</td>
<td>12405.410000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>15.000000</td>
<td>-40.623900</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10%</td>
<td>12940.100000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>89.000000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>13831.250000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>320.500000</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>15316.500000</td>
<td>2.000000</td>
<td>225.000000</td>
<td>536.000000</td>
<td>174.900625</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>16801.750000</td>
<td>6.000000</td>
<td>518.000000</td>
<td>674.000000</td>
<td>314.594375</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">90%</td>
<td>17692.900000</td>
<td>13.000000</td>
<td>672.900000</td>
<td>731.000000</td>
<td>502.095625</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99%</td>
<td>18227.590000</td>
<td>44.590000</td>
<td>734.000000</td>
<td>738.000000</td>
<td>1328.480453</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>18287.000000</td>
<td>284.000000</td>
<td>738.000000</td>
<td>738.000000</td>
<td>8513.271143</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As we can see how are frequency changing from 90 percentile to 99 percentile but same not the case with the recency as there is no much jump in the numbers so we can clearly see from there as well as there are some extreme values contains both in the frequency and monetary value.</p>
</section>
<section id="paretonbd-model" class="level2">
<h2 class="anchored" data-anchor-id="paretonbd-model">PARETO/NBD MODEL</h2>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes.plotting <span class="im">import</span> plot_frequency_recency_matrix</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes.plotting <span class="im">import</span> plot_probability_alive_matrix</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes.plotting <span class="im">import</span> plot_period_transactions</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes.utils <span class="im">import</span> calibration_and_holdout_data</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes <span class="im">import</span> ParetoNBDFitter</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes.plotting <span class="im">import</span> plot_history_alive</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> math <span class="im">import</span> sqrt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> math <span class="im">import</span> sqrt</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes <span class="im">import</span> ParetoNBDFitter</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_model(data, penalizer_val, time):</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    pareto_result <span class="op">=</span> data.copy()</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Fit Pareto/NBD ----</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    pareto_model <span class="op">=</span> ParetoNBDFitter(penalizer_coef<span class="op">=</span>penalizer_val)</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>    pareto_model.fit(</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>        pareto_result[<span class="st">"frequency"</span>],</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>        pareto_result[<span class="st">"recency"</span>],</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>        pareto_result[<span class="st">"T"</span>],</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> time</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Predicted purchases up to time t ----</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>    pareto_result[<span class="st">"predicted_purchases"</span>] <span class="op">=</span> (</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>        pareto_model.conditional_expected_number_of_purchases_up_to_time(</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>            t,</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>            pareto_result[<span class="st">"frequency"</span>],</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>            pareto_result[<span class="st">"recency"</span>],</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>            pareto_result[<span class="st">"T"</span>],</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- "Actual" baseline (your original definition) ----</span></span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: recency can be 0 -&gt; inf/NaN. We will clean inf/NaN right after.</span></span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>    pareto_result[<span class="st">"Actual_Purchases"</span>] <span class="op">=</span> (</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>        pareto_result[<span class="st">"frequency"</span>] <span class="op">/</span> pareto_result[<span class="st">"recency"</span>] <span class="op">*</span> t</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Clean invalid values (NaN/inf) created during calculations ----</span></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>    pareto_result.replace([np.inf, <span class="op">-</span>np.inf], np.nan, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Only evaluate on rows where both actual &amp; predicted are finite</span></span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>    eval_df <span class="op">=</span> pareto_result[[<span class="st">"Actual_Purchases"</span>, <span class="st">"predicted_purchases"</span>]].dropna()</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> eval_df.empty:</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">"No valid rows to evaluate after cleaning NaN/inf. "</span></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Most likely many recency values are 0. "</span></span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Consider using frequency/T * time as the baseline instead."</span></span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Errors &amp; metrics ----</span></span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a>    residual <span class="op">=</span> eval_df[<span class="st">"Actual_Purchases"</span>] <span class="op">-</span> eval_df[<span class="st">"predicted_purchases"</span>]</span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a>    pareto_mse_purchase <span class="op">=</span> mean_squared_error(</span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a>        eval_df[<span class="st">"Actual_Purchases"</span>], eval_df[<span class="st">"predicted_purchases"</span>]</span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a>    pareto_r2_purchase <span class="op">=</span> r2_score(</span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a>        eval_df[<span class="st">"Actual_Purchases"</span>], eval_df[<span class="st">"predicted_purchases"</span>]</span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a>    pareto_rmse_purchase <span class="op">=</span> sqrt(pareto_mse_purchase)</span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a>    pareto_avg_error_purchase <span class="op">=</span> residual.mean()</span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Predicted Purchase Mean Squared Error: </span><span class="sc">{</span>pareto_mse_purchase<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Predicted Purchase R2 Score: </span><span class="sc">{</span>pareto_r2_purchase<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Predicted Purchase Root Mean Squared Error: </span><span class="sc">{</span>pareto_rmse_purchase<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Predicted Purchase Average Purchases Error: </span><span class="sc">{</span>pareto_avg_error_purchase<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Plot: Actual vs Predicted with non-negative yerr ----</span></span>
<span id="cb75-67"><a href="#cb75-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Matplotlib requires yerr &gt;= 0. Use absolute residual as error magnitude.</span></span>
<span id="cb75-68"><a href="#cb75-68" aria-hidden="true" tabindex="-1"></a>    yerr <span class="op">=</span> np.<span class="bu">abs</span>(residual)</span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true" tabindex="-1"></a>    plt.errorbar(</span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true" tabindex="-1"></a>        eval_df[<span class="st">"Actual_Purchases"</span>],</span>
<span id="cb75-73"><a href="#cb75-73" aria-hidden="true" tabindex="-1"></a>        eval_df[<span class="st">"predicted_purchases"</span>],</span>
<span id="cb75-74"><a href="#cb75-74" aria-hidden="true" tabindex="-1"></a>        yerr<span class="op">=</span>yerr,</span>
<span id="cb75-75"><a href="#cb75-75" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">=</span><span class="st">"o"</span>,</span>
<span id="cb75-76"><a href="#cb75-76" aria-hidden="true" tabindex="-1"></a>        ecolor<span class="op">=</span><span class="st">"grey"</span>,</span>
<span id="cb75-77"><a href="#cb75-77" aria-hidden="true" tabindex="-1"></a>        elinewidth<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb75-78"><a href="#cb75-78" aria-hidden="true" tabindex="-1"></a>        capsize<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb75-79"><a href="#cb75-79" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb75-80"><a href="#cb75-80" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-81"><a href="#cb75-81" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Actual Purchases (proxy)"</span>)</span>
<span id="cb75-82"><a href="#cb75-82" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Predicted Purchases"</span>)</span>
<span id="cb75-83"><a href="#cb75-83" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">"Prediction v/s Actual"</span>)</span>
<span id="cb75-84"><a href="#cb75-84" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb75-85"><a href="#cb75-85" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb75-86"><a href="#cb75-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-87"><a href="#cb75-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pareto_model, pareto_result, eval_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Run ----</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>rfm_summary_clean <span class="op">=</span> rfm_summary.dropna()</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> rfm_summary_clean.isnull().values.<span class="bu">any</span>()</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>model, pareto_result, eval_df <span class="op">=</span> get_model(rfm_summary_clean, <span class="fl">0.001</span>, <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Predicted Purchase Mean Squared Error: 5.85565950515761
Predicted Purchase R2 Score: -0.04275685629787529
Predicted Purchase Root Mean Squared Error: 2.419847000361306
Predicted Purchase Average Purchases Error: 0.5847238329914886</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-64-output-2.svg" class="img-fluid"></p>
</div>
</div>
<p>Based on the above errors, we have found that penalizer_coef = 0.1 is doing slightly better at minimizing the errors so we will be using 0.1 for our model.</p>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>pareto_model <span class="op">=</span> lifetimes.ParetoNBDFitter(penalizer_coef <span class="op">=</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>pareto_model.fit(rfm_summary[<span class="st">"frequency"</span>],rfm_summary[<span class="st">"recency"</span>],</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>                rfm_summary[<span class="st">"T"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;lifetimes.ParetoNBDFitter: fitted with 5942 subjects, alpha: 63.87, beta: 124.24, r: 0.83, s: 0.16&gt;</code></pre>
</div>
</div>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>))</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>plot_frequency_recency_matrix(pareto_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: title={'center': 'Expected Number of Future Purchases for 1 Unit of Time,\nby Frequency and Recency of a Customer'}, xlabel="Customer's Historical Frequency", ylabel="Customer's Recency"&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-67-output-2.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>))</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>plot_probability_alive_matrix(pareto_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: title={'center': 'Probability Customer is Alive,\nby Frequency and Recency of a Customer'}, xlabel="Customer's Historical Frequency", ylabel="Customer's Recency"&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-68-output-2.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>pareto_result <span class="op">=</span> rfm_summary.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>pareto_result[<span class="st">"p_not_alive"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> pareto_model.conditional_probability_alive(</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    pareto_result[<span class="st">"frequency"</span>], pareto_result[<span class="st">"recency"</span>], pareto_result[<span class="st">"T"</span>]</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>pareto_result[<span class="st">"p_alive"</span>] <span class="op">=</span> pareto_model.conditional_probability_alive(</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    pareto_result[<span class="st">"frequency"</span>], pareto_result[<span class="st">"recency"</span>], pareto_result[<span class="st">"T"</span>]</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>pareto_result.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">recency</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">monetary_value</th>
<th data-quarto-table-cell-role="th">p_not_alive</th>
<th data-quarto-table-cell-role="th">p_alive</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>12346.0</td>
<td>10.0</td>
<td>400.0</td>
<td>725.0</td>
<td>-15.468000</td>
<td>0.819907</td>
<td>0.180093</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>12347.0</td>
<td>7.0</td>
<td>402.0</td>
<td>404.0</td>
<td>717.398571</td>
<td>0.000634</td>
<td>0.999366</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>12348.0</td>
<td>4.0</td>
<td>363.0</td>
<td>438.0</td>
<td>449.310000</td>
<td>0.034898</td>
<td>0.965102</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>12349.0</td>
<td>4.0</td>
<td>717.0</td>
<td>735.0</td>
<td>1107.172500</td>
<td>0.003675</td>
<td>0.996325</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>12350.0</td>
<td>0.0</td>
<td>0.0</td>
<td>310.0</td>
<td>0.000000</td>
<td>0.334751</td>
<td>0.665249</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>pareto_result[<span class="st">"predicted_purchases"</span>] <span class="op">=</span> pareto_model.conditional_expected_number_of_purchases_up_to_time(t, pareto_result[<span class="st">"frequency"</span>], pareto_result[<span class="st">"recency"</span>], pareto_result[<span class="st">"T"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>pareto_result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">recency</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">monetary_value</th>
<th data-quarto-table-cell-role="th">p_not_alive</th>
<th data-quarto-table-cell-role="th">p_alive</th>
<th data-quarto-table-cell-role="th">predicted_purchases</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>12346.0</td>
<td>10.0</td>
<td>400.0</td>
<td>725.0</td>
<td>-15.468000</td>
<td>0.819907</td>
<td>0.180093</td>
<td>0.073991</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>12347.0</td>
<td>7.0</td>
<td>402.0</td>
<td>404.0</td>
<td>717.398571</td>
<td>0.000634</td>
<td>0.999366</td>
<td>0.499742</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>12348.0</td>
<td>4.0</td>
<td>363.0</td>
<td>438.0</td>
<td>449.310000</td>
<td>0.034898</td>
<td>0.965102</td>
<td>0.277710</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>12349.0</td>
<td>4.0</td>
<td>717.0</td>
<td>735.0</td>
<td>1107.172500</td>
<td>0.003675</td>
<td>0.996325</td>
<td>0.180375</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>12350.0</td>
<td>0.0</td>
<td>0.0</td>
<td>310.0</td>
<td>0.000000</td>
<td>0.334751</td>
<td>0.665249</td>
<td>0.044307</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5937</td>
<td>18283.0</td>
<td>18.0</td>
<td>655.0</td>
<td>658.0</td>
<td>146.405556</td>
<td>0.000657</td>
<td>0.999343</td>
<td>0.779793</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5938</td>
<td>18284.0</td>
<td>1.0</td>
<td>2.0</td>
<td>431.0</td>
<td>-25.000000</td>
<td>0.730101</td>
<td>0.269899</td>
<td>0.029887</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5939</td>
<td>18285.0</td>
<td>0.0</td>
<td>0.0</td>
<td>660.0</td>
<td>0.000000</td>
<td>0.523594</td>
<td>0.476406</td>
<td>0.016428</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5940</td>
<td>18286.0</td>
<td>2.0</td>
<td>247.0</td>
<td>723.0</td>
<td>362.740000</td>
<td>0.417568</td>
<td>0.582432</td>
<td>0.062764</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5941</td>
<td>18287.0</td>
<td>6.0</td>
<td>696.0</td>
<td>738.0</td>
<td>697.165000</td>
<td>0.009872</td>
<td>0.990128</td>
<td>0.252461</td>
</tr>
</tbody>
</table>

<p>5942 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>plot_period_transactions(pareto_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: title={'center': 'Frequency of Repeat Transactions'}, xlabel='Number of Calibration Period Transactions', ylabel='Customers'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-74-output-2.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dividing our dataset into training &amp; holdout</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>pareto_summary_cal_holdout <span class="op">=</span> calibration_and_holdout_data(</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Customer ID"</span>,</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"InvoiceDate"</span>,</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    calibration_period_end<span class="op">=</span><span class="st">"2011-06-08"</span>,</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    observation_period_end<span class="op">=</span><span class="st">"2011-12-09"</span>,</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>pareto_summary_cal_holdout.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">frequency_cal</th>
<th data-quarto-table-cell-role="th">recency_cal</th>
<th data-quarto-table-cell-role="th">T_cal</th>
<th data-quarto-table-cell-role="th">frequency_holdout</th>
<th data-quarto-table-cell-role="th">duration_holdout</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">12346.0</td>
<td>10.0</td>
<td>400.0</td>
<td>541.0</td>
<td>0.0</td>
<td>184.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12347.0</td>
<td>3.0</td>
<td>158.0</td>
<td>220.0</td>
<td>4.0</td>
<td>184.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12348.0</td>
<td>3.0</td>
<td>190.0</td>
<td>254.0</td>
<td>1.0</td>
<td>184.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12349.0</td>
<td>3.0</td>
<td>328.0</td>
<td>551.0</td>
<td>1.0</td>
<td>184.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12350.0</td>
<td>0.0</td>
<td>0.0</td>
<td>126.0</td>
<td>0.0</td>
<td>184.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>pareto_model.fit(</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    pareto_summary_cal_holdout[<span class="st">"frequency_cal"</span>],</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    pareto_summary_cal_holdout[<span class="st">"recency_cal"</span>],</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    pareto_summary_cal_holdout[<span class="st">"T_cal"</span>],</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;lifetimes.ParetoNBDFitter: fitted with 5025 subjects, alpha: 63.81, beta: 801.30, r: 0.83, s: 0.76&gt;</code></pre>
</div>
</div>
<div class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes.plotting <span class="im">import</span> plot_calibration_purchases_vs_holdout_purchases</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>plot_calibration_purchases_vs_holdout_purchases(pareto_model, pareto_summary_cal_holdout)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: title={'center': 'Actual Purchases in Holdout Period vs Predicted Purchases'}, xlabel='Purchases in calibration period', ylabel='Average of Purchases in Holdout Period'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-79-output-2.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>pareto_summary_cal_holdout.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">frequency_cal</th>
<th data-quarto-table-cell-role="th">recency_cal</th>
<th data-quarto-table-cell-role="th">T_cal</th>
<th data-quarto-table-cell-role="th">frequency_holdout</th>
<th data-quarto-table-cell-role="th">duration_holdout</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">12346.0</td>
<td>10.0</td>
<td>400.0</td>
<td>541.0</td>
<td>0.0</td>
<td>184.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12347.0</td>
<td>3.0</td>
<td>158.0</td>
<td>220.0</td>
<td>4.0</td>
<td>184.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12348.0</td>
<td>3.0</td>
<td>190.0</td>
<td>254.0</td>
<td>1.0</td>
<td>184.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12349.0</td>
<td>3.0</td>
<td>328.0</td>
<td>551.0</td>
<td>1.0</td>
<td>184.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12350.0</td>
<td>0.0</td>
<td>0.0</td>
<td>126.0</td>
<td>0.0</td>
<td>184.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>pareto_result[<span class="st">"actual30"</span>] <span class="op">=</span> pareto_result[<span class="st">"frequency"</span>]<span class="op">/</span>pareto_result[<span class="st">"recency"</span>]<span class="op">*</span><span class="dv">30</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>pareto_result[<span class="st">"actual30"</span>].fillna(<span class="dv">0</span>, inplace <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>pareto_result[<span class="st">"error"</span>] <span class="op">=</span> pareto_result[<span class="st">"actual30"</span>]<span class="op">-</span>pareto_result[<span class="st">"predicted_purchases"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>pareto_result.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">recency</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">monetary_value</th>
<th data-quarto-table-cell-role="th">p_not_alive</th>
<th data-quarto-table-cell-role="th">p_alive</th>
<th data-quarto-table-cell-role="th">predicted_purchases</th>
<th data-quarto-table-cell-role="th">actual30</th>
<th data-quarto-table-cell-role="th">error</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>12346.0</td>
<td>10.0</td>
<td>400.0</td>
<td>725.0</td>
<td>-15.468000</td>
<td>0.819907</td>
<td>0.180093</td>
<td>0.073991</td>
<td>0.750000</td>
<td>0.676009</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>12347.0</td>
<td>7.0</td>
<td>402.0</td>
<td>404.0</td>
<td>717.398571</td>
<td>0.000634</td>
<td>0.999366</td>
<td>0.499742</td>
<td>0.522388</td>
<td>0.022646</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>12348.0</td>
<td>4.0</td>
<td>363.0</td>
<td>438.0</td>
<td>449.310000</td>
<td>0.034898</td>
<td>0.965102</td>
<td>0.277710</td>
<td>0.330579</td>
<td>0.052868</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>12349.0</td>
<td>4.0</td>
<td>717.0</td>
<td>735.0</td>
<td>1107.172500</td>
<td>0.003675</td>
<td>0.996325</td>
<td>0.180375</td>
<td>0.167364</td>
<td>-0.013011</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>12350.0</td>
<td>0.0</td>
<td>0.0</td>
<td>310.0</td>
<td>0.000000</td>
<td>0.334751</td>
<td>0.665249</td>
<td>0.044307</td>
<td>0.000000</td>
<td>-0.044307</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> math <span class="im">import</span> sqrt</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_metrics(true, predicted, error, title<span class="op">=</span><span class="st">"Actual Purchase v/s Predicted Purchase"</span>):</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) 拼成一个 dataframe，统一清理</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> np.column_stack([true, predicted, error])</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> np.array(df, dtype<span class="op">=</span><span class="st">"float64"</span>)</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) 过滤掉 NaN/inf（sklearn 不接受）</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> np.isfinite(df).<span class="bu">all</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mask.<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"No valid rows after removing NaN/inf. "</span></span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Check whether actual values contain division-by-zero (e.g., recency==0)."</span></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> df[mask, <span class="dv">0</span>]</span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> df[mask, <span class="dv">1</span>]</span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>    err <span class="op">=</span> df[mask, <span class="dv">2</span>]</span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) 指标</span></span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> mean_squared_error(y_true, y_pred)</span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> sqrt(mse)</span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(y_true, y_pred)</span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Squared Error: </span><span class="sc">{</span>mse<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Root Mean Squared Error: </span><span class="sc">{</span>rmse<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"R2 Score: </span><span class="sc">{</span>r2<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4) 可视化：size 需要非负（建议用 abs(error)）</span></span>
<span id="cb104-35"><a href="#cb104-35" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">4</span>))</span>
<span id="cb104-36"><a href="#cb104-36" aria-hidden="true" tabindex="-1"></a>    sns.scatterplot(</span>
<span id="cb104-37"><a href="#cb104-37" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>y_true,</span>
<span id="cb104-38"><a href="#cb104-38" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span>y_pred,</span>
<span id="cb104-39"><a href="#cb104-39" aria-hidden="true" tabindex="-1"></a>        size<span class="op">=</span>np.<span class="bu">abs</span>(err),</span>
<span id="cb104-40"><a href="#cb104-40" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"darkolivegreen"</span>,</span>
<span id="cb104-41"><a href="#cb104-41" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.4</span>,</span>
<span id="cb104-42"><a href="#cb104-42" aria-hidden="true" tabindex="-1"></a>        legend<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb104-43"><a href="#cb104-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb104-44"><a href="#cb104-44" aria-hidden="true" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb104-45"><a href="#cb104-45" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Actual"</span>)</span>
<span id="cb104-46"><a href="#cb104-46" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Predicted"</span>)</span>
<span id="cb104-47"><a href="#cb104-47" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb104-48"><a href="#cb104-48" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>get_metrics(</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    pareto_result[<span class="st">"actual30"</span>],</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    pareto_result[<span class="st">"predicted_purchases"</span>],</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    pareto_result[<span class="st">"error"</span>],</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean Squared Error: 4.337247630142553
Root Mean Squared Error: 2.0826059709274225
R2 Score: -0.0001399519253646453</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-86-output-2.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes.plotting <span class="im">import</span> plot_history_alive</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes.plotting <span class="im">import</span> calculate_alive_path</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_history_alive_fixed(</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    model, t, transactions, datetime_col<span class="op">=</span><span class="st">"InvoiceDate"</span>, freq<span class="op">=</span><span class="st">"D"</span>, ax<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a><span class="co">    A pandas-compatible replacement for lifetimes.plotting.plot_history_alive</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a><span class="co">    that avoids summing datetime64 columns by using numeric_only=True.</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ax <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> plt.gca()</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>    tx <span class="op">=</span> transactions.copy()</span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure datetime</span></span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>    tx[datetime_col] <span class="op">=</span> pd.to_datetime(tx[datetime_col], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>    tx <span class="op">=</span> tx.dropna(subset<span class="op">=</span>[datetime_col])</span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tx.empty:</span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No valid transactions after datetime parsing/cleaning."</span>)</span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build customer history as a time series of transaction counts</span></span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>    customer_history <span class="op">=</span> tx[[datetime_col]].copy()</span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>    customer_history[<span class="st">"transactions"</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>    customer_history <span class="op">=</span> customer_history.set_index(datetime_col).sort_index()</span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Key fix: numeric_only=True prevents pandas from trying to sum datetime columns</span></span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a>    customer_history <span class="op">=</span> customer_history.resample(freq).<span class="bu">sum</span>(numeric_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alive path</span></span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a>    path <span class="op">=</span> calculate_alive_path(model, tx, datetime_col, t, freq)</span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dates aligned with the path length</span></span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a>    path_dates <span class="op">=</span> pd.date_range(</span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a>        start<span class="op">=</span>customer_history.index.<span class="bu">min</span>(), periods<span class="op">=</span><span class="bu">len</span>(path), freq<span class="op">=</span>freq</span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a>    ax.plot(path_dates, path, <span class="st">"-"</span>, label<span class="op">=</span><span class="st">"P_alive"</span>, <span class="op">**</span>kwargs)</span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot actual transaction days as vertical markers (optional but useful)</span></span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a>    buy_dates <span class="op">=</span> tx[datetime_col].sort_values().tolist()</span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a>    ax.vlines(buy_dates, ymin<span class="op">=</span><span class="dv">0</span>, ymax<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.15</span>)</span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(<span class="dv">0</span>, <span class="fl">1.05</span>)</span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">"History Alive"</span>)</span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"P(alive)"</span>)</span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">"best"</span>)</span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_history_alive(</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    t_, data_, id_, customer_col<span class="op">=</span><span class="st">"Customer ID"</span>, datetime_col<span class="op">=</span><span class="st">"InvoiceDate"</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    individual <span class="op">=</span> data_.loc[</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>        data_[customer_col] <span class="op">==</span> id_, [customer_col, datetime_col]</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    plot_history_alive_fixed(</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>        pareto_model,</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>        t<span class="op">=</span>t_,</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>        transactions<span class="op">=</span>individual,</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>        datetime_col<span class="op">=</span>datetime_col,</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>        freq<span class="op">=</span><span class="st">"D"</span>,</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>get_history_alive(<span class="dv">30</span>, data, <span class="fl">12358.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-89-output-1.svg" class="img-fluid"></p>
</div>
</div>
</section>
<section id="gamma-gamma-model" class="level2">
<h2 class="anchored" data-anchor-id="gamma-gamma-model">GAMMA-GAMMA MODEL</h2>
<p>Before proceding with our Gamma Gamma Model, we have to first filter the data where we are going to remove the values with 0 frequency and monetary values.</p>
<div class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> pareto_result[(pareto_result[<span class="st">"frequency"</span>] <span class="op">&lt;=</span> <span class="fl">0.0</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> idx.index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>ggf_filter <span class="op">=</span> pareto_result.drop(idx, axis <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>m_idx <span class="op">=</span> ggf_filter[(ggf_filter[<span class="st">"monetary_value"</span>] <span class="op">&lt;=</span> <span class="fl">0.0</span>)].index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>ggf_filter <span class="op">=</span> ggf_filter.drop(m_idx, axis <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>ggf_filter.reset_index().drop(<span class="st">"index"</span>, axis <span class="op">=</span> <span class="dv">1</span>, inplace <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">5</span>))</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>sns.heatmap(ggf_filter[[<span class="st">"frequency"</span>, <span class="st">"monetary_value"</span>]].corr(), annot<span class="op">=</span><span class="va">True</span>, cbar<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-96-output-2.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>ggf_model <span class="op">=</span>  lifetimes.GammaGammaFitter(penalizer_coef<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>ggf_model.fit(ggf_filter[<span class="st">"frequency"</span>], ggf_filter[<span class="st">"monetary_value"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;lifetimes.GammaGammaFitter: fitted with 4185 subjects, p: 1.02, q: 0.19, v: 0.95&gt;</code></pre>
</div>
</div>
<div class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>ggf_model.summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">se(coef)</th>
<th data-quarto-table-cell-role="th">lower 95% bound</th>
<th data-quarto-table-cell-role="th">upper 95% bound</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">p</td>
<td>1.023190</td>
<td>0.024652</td>
<td>0.974873</td>
<td>1.071508</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">q</td>
<td>0.185956</td>
<td>0.003114</td>
<td>0.179852</td>
<td>0.192060</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">v</td>
<td>0.947145</td>
<td>0.025498</td>
<td>0.897169</td>
<td>0.997122</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>ggf_filter[<span class="st">"expected_avg_sales_"</span>] <span class="op">=</span> ggf_model.conditional_expected_average_profit(ggf_filter[<span class="st">"frequency"</span>],</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>                                                                                     ggf_filter[<span class="st">"monetary_value"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>ggf_filter.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">recency</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">monetary_value</th>
<th data-quarto-table-cell-role="th">p_not_alive</th>
<th data-quarto-table-cell-role="th">p_alive</th>
<th data-quarto-table-cell-role="th">predicted_purchases</th>
<th data-quarto-table-cell-role="th">actual30</th>
<th data-quarto-table-cell-role="th">error</th>
<th data-quarto-table-cell-role="th">expected_avg_sales_</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>12347.0</td>
<td>7.0</td>
<td>402.0</td>
<td>404.0</td>
<td>717.398571</td>
<td>0.000634</td>
<td>0.999366</td>
<td>0.499742</td>
<td>0.522388</td>
<td>0.022646</td>
<td>809.543574</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>12348.0</td>
<td>4.0</td>
<td>363.0</td>
<td>438.0</td>
<td>449.310000</td>
<td>0.034898</td>
<td>0.965102</td>
<td>0.277710</td>
<td>0.330579</td>
<td>0.052868</td>
<td>561.160804</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>12349.0</td>
<td>4.0</td>
<td>717.0</td>
<td>735.0</td>
<td>1107.172500</td>
<td>0.003675</td>
<td>0.996325</td>
<td>0.180375</td>
<td>0.167364</td>
<td>-0.013011</td>
<td>1382.358199</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>12352.0</td>
<td>8.0</td>
<td>356.0</td>
<td>392.0</td>
<td>218.182500</td>
<td>0.017282</td>
<td>0.982718</td>
<td>0.568667</td>
<td>0.674157</td>
<td>0.105490</td>
<td>242.408202</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>12353.0</td>
<td>1.0</td>
<td>204.0</td>
<td>408.0</td>
<td>89.000000</td>
<td>0.126945</td>
<td>0.873055</td>
<td>0.101371</td>
<td>0.147059</td>
<td>0.045688</td>
<td>440.041239</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mean Squared Error: </span><span class="sc">%s</span><span class="st">"</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span> (</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>        mean_squared_error(</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>            ggf_filter[<span class="st">"monetary_value"</span>], ggf_filter[<span class="st">"expected_avg_sales_"</span>]</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Root Mean Squared Error: </span><span class="sc">%s</span><span class="st">"</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span> (</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>        sqrt(</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>            mean_squared_error(</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>                ggf_filter[<span class="st">"monetary_value"</span>], ggf_filter[<span class="st">"expected_avg_sales_"</span>]</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"R2 Score: </span><span class="sc">%s</span><span class="st">"</span></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span> (r2_score(ggf_filter[<span class="st">"monetary_value"</span>], ggf_filter[<span class="st">"expected_avg_sales_"</span>]))</span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean Squared Error: 793392.8848688784
Root Mean Squared Error: 890.7260436682417
R2 Score: -4.485799230636223</code></pre>
</div>
</div>
<div class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>ggf_filter[<span class="st">"predicted_clv"</span>] <span class="op">=</span> ggf_model.customer_lifetime_value(pareto_model,</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>                                                       ggf_filter[<span class="st">"frequency"</span>],</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>                                                       ggf_filter[<span class="st">"recency"</span>],</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>                                                       ggf_filter[<span class="st">"T"</span>],</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>                                                       ggf_filter[<span class="st">"monetary_value"</span>],</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>                                                       time <span class="op">=</span> <span class="dv">30</span>,</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>                                                       freq <span class="op">=</span> <span class="st">'D'</span>,</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>                                                       discount_rate <span class="op">=</span> <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Top 5 customers with high CLV</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>ggf_filter[[<span class="st">"Customer ID"</span>, <span class="st">"predicted_clv"</span>]].sort_values(by <span class="op">=</span> <span class="st">"predicted_clv"</span>, ascending <span class="op">=</span> <span class="va">False</span>).head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">predicted_clv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">5756</td>
<td>18102.0</td>
<td>494034.323786</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2300</td>
<td>14646.0</td>
<td>426705.718630</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5104</td>
<td>17450.0</td>
<td>252496.776218</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1810</td>
<td>14156.0</td>
<td>239243.228831</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1750</td>
<td>14096.0</td>
<td>225594.810548</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming 5% of Profit Margin</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="co">#ggf_filter["profit_margin"] = ggf_filter["predicted_clv"]*0.05</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="128">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>ggf_filter.reset_index().drop(<span class="st">"index"</span>, axis <span class="op">=</span> <span class="dv">1</span>, inplace <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co">#exporting the result to csv</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>ggf_filter.to_csv(<span class="st">"customer_lifetime_value_prediction.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="customer-segmentation-using-predicted-clv" class="level2">
<h2 class="anchored" data-anchor-id="customer-segmentation-using-predicted-clv">CUSTOMER SEGMENTATION USING PREDICTED CLV</h2>
<p>We have calculated the CLV and deliver the same to the marketing team but now marketing team is interested to know the most profitable customers segment which they can target the deliver the best optimized campaigns.</p>
<p>Our work is to deliver the requested data to the marketing team &amp; to perform the same we will be going to perform the clustering on the predicted metrics.</p>
<div class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>ggf_filter.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customer ID</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">recency</th>
<th data-quarto-table-cell-role="th">T</th>
<th data-quarto-table-cell-role="th">monetary_value</th>
<th data-quarto-table-cell-role="th">p_not_alive</th>
<th data-quarto-table-cell-role="th">p_alive</th>
<th data-quarto-table-cell-role="th">predicted_purchases</th>
<th data-quarto-table-cell-role="th">actual30</th>
<th data-quarto-table-cell-role="th">error</th>
<th data-quarto-table-cell-role="th">expected_avg_sales_</th>
<th data-quarto-table-cell-role="th">predicted_clv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>12347.0</td>
<td>7.0</td>
<td>402.0</td>
<td>404.0</td>
<td>717.398571</td>
<td>0.000634</td>
<td>0.999366</td>
<td>0.499742</td>
<td>0.522388</td>
<td>0.022646</td>
<td>809.543574</td>
<td>8446.909497</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>12348.0</td>
<td>4.0</td>
<td>363.0</td>
<td>438.0</td>
<td>449.310000</td>
<td>0.034898</td>
<td>0.965102</td>
<td>0.277710</td>
<td>0.330579</td>
<td>0.052868</td>
<td>561.160804</td>
<td>3153.823377</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>12349.0</td>
<td>4.0</td>
<td>717.0</td>
<td>735.0</td>
<td>1107.172500</td>
<td>0.003675</td>
<td>0.996325</td>
<td>0.180375</td>
<td>0.167364</td>
<td>-0.013011</td>
<td>1382.358199</td>
<td>5372.065578</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>12352.0</td>
<td>8.0</td>
<td>356.0</td>
<td>392.0</td>
<td>218.182500</td>
<td>0.017282</td>
<td>0.982718</td>
<td>0.568667</td>
<td>0.674157</td>
<td>0.105490</td>
<td>242.408202</td>
<td>2827.898475</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>12353.0</td>
<td>1.0</td>
<td>204.0</td>
<td>408.0</td>
<td>89.000000</td>
<td>0.126945</td>
<td>0.873055</td>
<td>0.101371</td>
<td>0.147059</td>
<td>0.045688</td>
<td>440.041239</td>
<td>844.425922</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>col <span class="op">=</span> [<span class="st">"predicted_purchases"</span>, <span class="st">"expected_avg_sales_"</span>, <span class="st">"predicted_clv"</span>, <span class="st">"profit_margin"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>col <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> col <span class="cf">if</span> c <span class="kw">in</span> ggf_filter.columns]</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> col:</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="st">"None of the requested columns found in ggf_filter"</span>)</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>sns.pairplot(ggf_filter[col], diag_kind<span class="op">=</span><span class="st">"kde"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-110-output-1.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>new_df <span class="op">=</span> ggf_filter[col]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> new_df.select_dtypes(include<span class="op">=</span>[np.number]).replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline(</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"imputer"</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)),</span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"scaler"</span>, StandardScaler()),</span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"kmeans"</span>, KMeans(init<span class="op">=</span><span class="st">"k-means++"</span>, n_init<span class="op">=</span><span class="dv">10</span>, random_state<span class="op">=</span><span class="dv">42</span>)),</span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>inertia <span class="op">=</span> []</span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">11</span>):</span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>    pipe.set_params(kmeans__n_clusters<span class="op">=</span>k)</span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a>    pipe.fit(X)</span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a>    inertia.append(pipe.named_steps[<span class="st">"kmeans"</span>].inertia_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="173">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="bu">range</span>(<span class="dv">2</span>,<span class="dv">11</span>), inertia, marker <span class="op">=</span> <span class="st">"*"</span>, linewidth <span class="op">=</span> <span class="fl">1.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-113-output-1.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>k_model <span class="op">=</span> KMeans(n_clusters<span class="op">=</span><span class="dv">4</span>, init<span class="op">=</span><span class="st">"k-means++"</span>, max_iter<span class="op">=</span><span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> new_df.select_dtypes(include<span class="op">=</span>[np.number]).replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>k_model <span class="op">=</span> KMeans(</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    n_clusters<span class="op">=</span><span class="dv">5</span>, init<span class="op">=</span><span class="st">"k-means++"</span>, n_init<span class="op">=</span><span class="dv">10</span>, random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>)  <span class="co"># 你的 k_model 参数按需替换</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline(</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"imputer"</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)),</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"scaler"</span>, StandardScaler()),</span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"kmeans"</span>, k_model),</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>k_model_fit <span class="op">=</span> pipe.fit(X)</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> pipe.named_steps[<span class="st">"kmeans"</span>].labels_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>new_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">predicted_purchases</th>
<th data-quarto-table-cell-role="th">expected_avg_sales_</th>
<th data-quarto-table-cell-role="th">predicted_clv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>0.499742</td>
<td>809.543574</td>
<td>8446.909497</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>0.277710</td>
<td>561.160804</td>
<td>3153.823377</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>0.180375</td>
<td>1382.358199</td>
<td>5372.065578</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>0.568667</td>
<td>242.408202</td>
<td>2827.898475</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>0.101371</td>
<td>440.041239</td>
<td>844.425922</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5935</td>
<td>0.080078</td>
<td>400.022878</td>
<td>630.829376</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5936</td>
<td>0.441468</td>
<td>64.211847</td>
<td>564.740478</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5937</td>
<td>0.779793</td>
<td>153.230929</td>
<td>2570.835613</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5940</td>
<td>0.062764</td>
<td>603.141334</td>
<td>555.635907</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5941</td>
<td>0.252461</td>
<td>803.922101</td>
<td>4333.607894</td>
</tr>
</tbody>
</table>

<p>4185 rows × 3 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">hasattr</span>(k_model_fit, <span class="st">"cluster_centers_"</span>):</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    centers <span class="op">=</span> k_model_fit.cluster_centers_</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the final estimator from the Pipeline (or the named 'kmeans' step if present)</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(k_model_fit, <span class="st">"named_steps"</span>) <span class="kw">and</span> <span class="st">"kmeans"</span> <span class="kw">in</span> k_model_fit.named_steps:</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>        estimator <span class="op">=</span> k_model_fit.named_steps[<span class="st">"kmeans"</span>]</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>        estimator <span class="op">=</span> k_model_fit.steps[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>    centers <span class="op">=</span> estimator.cluster_centers_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>centers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([[-0.23392374, -0.16187555, -0.14373855],
       [ 6.93833323,  3.32495846, 17.11743082],
       [ 1.92122656, -0.18410288,  0.53029489],
       [-0.47701477, 17.06579121,  3.22090096],
       [-0.45255038,  2.27274781,  0.40269531]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">hasattr</span>(k_model_fit, <span class="st">"labels_"</span>):</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> k_model_fit.labels_</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>        final_est <span class="op">=</span> k_model_fit.named_steps[<span class="bu">list</span>(k_model_fit.named_steps.keys())[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>        final_est <span class="op">=</span> k_model_fit.steps[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(final_est, <span class="st">"labels_"</span>):</span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> final_est.labels_</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">hasattr</span>(final_est, <span class="st">"predict"</span>):</span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> final_est.predict(X)  <span class="co"># ensure X is your input data</span></span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">AttributeError</span>(<span class="st">"Final estimator has no 'labels_' and cannot predict; provide data 'X' or access the correct estimator."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> pd.Series(labels, name <span class="op">=</span> <span class="st">"Labels"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="155">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>ggf_filter <span class="op">=</span> pd.concat([ggf_filter, labels], axis <span class="op">=</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="156">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>label_mapper <span class="op">=</span> <span class="bu">dict</span>({<span class="dv">0</span> : <span class="st">"Low"</span>, <span class="dv">3</span>: <span class="st">"Medium"</span>, <span class="dv">1</span>: <span class="st">"High"</span>, <span class="dv">2</span>: <span class="st">"V_High"</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="157">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>ggf_filter[<span class="st">"Labels"</span>] <span class="op">=</span> ggf_filter[<span class="st">"Labels"</span>].<span class="bu">map</span>(label_mapper)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>ggf_filter.groupby(<span class="st">"Labels"</span>).mean().T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Labels</th>
<th data-quarto-table-cell-role="th">High</th>
<th data-quarto-table-cell-role="th">Low</th>
<th data-quarto-table-cell-role="th">Medium</th>
<th data-quarto-table-cell-role="th">V_High</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Customer ID</td>
<td>14435.000000</td>
<td>14456.760835</td>
<td>13349.000000</td>
<td>14360.820513</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">frequency</td>
<td>10.400000</td>
<td>7.995987</td>
<td>3.000000</td>
<td>6.592949</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">recency</td>
<td>485.400000</td>
<td>391.062199</td>
<td>291.400000</td>
<td>366.810897</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">T</td>
<td>573.400000</td>
<td>524.010433</td>
<td>480.800000</td>
<td>526.496795</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">monetary_value</td>
<td>250.246097</td>
<td>339.635489</td>
<td>223.721833</td>
<td>325.774253</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">p_not_alive</td>
<td>0.172702</td>
<td>0.153311</td>
<td>0.236693</td>
<td>0.176677</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">p_alive</td>
<td>0.827298</td>
<td>0.846689</td>
<td>0.763307</td>
<td>0.823323</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">predicted_purchases</td>
<td>0.481304</td>
<td>0.405209</td>
<td>0.220158</td>
<td>0.354391</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">actual30</td>
<td>1.109715</td>
<td>0.764558</td>
<td>0.769879</td>
<td>0.722696</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">error</td>
<td>0.628411</td>
<td>0.353305</td>
<td>0.549722</td>
<td>0.368305</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">expected_avg_sales_</td>
<td>294.049288</td>
<td>631.484150</td>
<td>342.271580</td>
<td>643.789162</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">predicted_clv</td>
<td>2899.052279</td>
<td>4500.574505</td>
<td>1357.144436</td>
<td>4083.807197</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"predicted_purchases"</span>,</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"predicted_clv"</span>,</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"Labels"</span>,</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"Set1"</span>,</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>ggf_filter,</span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>plt.scatter(centers[:, <span class="dv">0</span>], centers[:, <span class="dv">2</span>], marker<span class="op">=</span><span class="st">"x"</span>, color<span class="op">=</span><span class="st">"k"</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"upper center"</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">0.5</span>, <span class="op">-</span><span class="fl">0.05</span>), shadow<span class="op">=</span><span class="va">True</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;matplotlib.legend.Legend at 0x311853bc0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-125-output-2.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">5</span>))</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> ggf_filter[<span class="st">"Labels"</span>].value_counts()</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>explode <span class="op">=</span> [<span class="fl">0.0</span>] <span class="op">+</span> [<span class="fl">0.15</span>] <span class="op">*</span> (<span class="bu">len</span>(counts) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>ax.pie(counts, labels<span class="op">=</span>counts.index, startangle<span class="op">=</span><span class="dv">180</span>, explode<span class="op">=</span>explode, autopct<span class="op">=</span><span class="st">"</span><span class="sc">%1.2f%%</span><span class="st">"</span>)</span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Label Percentage"</span>)</span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'equal'</span>)</span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-126-output-1.svg" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="CLV%20-%20Final_files/figure-html/cell-126-output-2.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>ggf_filter.to_csv(</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"/Users/sousekilyu/Documents/Python/CLV/customer_segmentation_result.csv"</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="170">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">"models"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>joblib.dump(pareto_model.params_, <span class="st">"models/pareto_nbd_params.pkl"</span>)</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>joblib.dump(ggf_model.params_, <span class="st">"models/gamma_model_params.pkl"</span>)</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>joblib.dump(k_model, <span class="st">"models/k_means.pkl"</span>)  <span class="co"># KMeans 可以直接存</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['models/k_means.pkl']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="171">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes <span class="im">import</span> ParetoNBDFitter, GammaGammaFitter</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Pareto/NBD</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>pareto_model_loaded <span class="op">=</span> ParetoNBDFitter()</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>pareto_model_loaded.params_ <span class="op">=</span> joblib.load(<span class="st">"models/pareto_nbd_params.pkl"</span>)</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Gamma-Gamma</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>ggf_model_loaded <span class="op">=</span> GammaGammaFitter()</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>ggf_model_loaded.params_ <span class="op">=</span> joblib.load(<span class="st">"models/gamma_model_params.pkl"</span>)</span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a><span class="co"># KMeans</span></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>k_model_loaded <span class="op">=</span> joblib.load(<span class="st">"models/k_means.pkl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now it’s time to deploy our model and for that we have saved the model using the above code.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>